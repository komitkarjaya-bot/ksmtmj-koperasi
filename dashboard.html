<script>
const params = new URLSearchParams(window.location.search);
const token = params.get("token");

if (!token) {
  showError("Token tidak ditemukan. Silakan login ulang.");
} else {
  loadDashboardJSONP(token);
}

function loadDashboardJSONP(token) {

  const callbackName = "cb_" + Date.now();

  window[callbackName] = function (data) {

    document.getElementById("loading").style.display = "none";

    if (data.error) {
      showError(data.error);
      return;
    }

    document.getElementById("data").style.display = "block";
    document.getElementById("noanggota").innerText = data.noanggota;
    document.getElementById("nama").innerText = data.nama;
    document.getElementById("email").innerText = data.email;
    document.getElementById("pokok").innerText = formatRupiah(data.pokok);
    document.getElementById("wajib").innerText = formatRupiah(data.wajib);
    document.getElementById("sukarela").innerText = formatRupiah(data.sukarela);

    delete window[callbackName];
  };

  const script = document.createElement("script");
  script.src =
    "https://script.google.com/macros/s/AKfycby0byagmf3xMu3_EAIjQoOATRg3Wk4Ehby0fnt6-hrzXG4DNu2AHRH3xYzz8x1C3oAh/exec" +
    "?token=" + encodeURIComponent(token) +
    "&callback=" + callbackName;

  script.onerror = function () {
    showError("Gagal menghubungi server (JSONP).");
  };

  document.body.appendChild(script);
}

function showError(msg) {
  document.getElementById("loading").style.display = "none";
  const e = document.getElementById("error");
  e.style.display = "block";
  e.innerText = msg;
}

function formatRupiah(n) {
  return "Rp " + Number(n).toLocaleString("id-ID");
}
</script>
